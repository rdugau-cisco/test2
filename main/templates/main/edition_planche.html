{% extends "base.html" %}

{% block javascript %}
    <script type="text/javascript" src="{{ STATIC_URL }}javascripts/myTools.js"></script>

	<style>


#matrice { 
    list-style-type: none; 
    margin:0; padding:0; width: 100px;height:100px; 
    border:5px solid #00D6D6; 
    float:left;
    border-style-right:dotted;
    }
	


</style>

	<script>
	
    bEnMouvement = false
    pxParCm = 8
    plant_courant = ""
    g_tab_tickets = new Array()
    jsonVarietes = {  {% for var in l_vars %} {{var.id}}:'{{var.nom}}',{% endfor %}  }

function init()
    {
    document.getElementById("matrice").style.height = ({{planche.largeur_cm}} * pxParCm ).toString() + "px"
    // la longuer est coupée , on fait un carré
    document.getElementById("matrice").style.width = ({{planche.largeur_cm}} * pxParCm ).toString() + "px"
    }



function getTicket()
{
    g_tab_tickets.push("0")
    return(g_tab_tickets.length) 
}
    
function ajoutPlan()
    {
    s_nouveauPlanId = 'plant_' + getTicket()
    s_plant = '<div class="Plan" id="' + s_nouveauPlanId + '"'
    s_plant += ' onmouseover="plant_courant=' + "'" + s_nouveauPlanId + "'" + '" onmouseout="plant_courant=' + "''" + '"'
    s_plant += '" onmousedown="toggleMove()" onmouseup="toggleMove()" variete="" largeur_cm="" hauteur_cm="" coord_x_cm="" cord_y_cm="">'
    s_plant += s_nouveauPlanId 
    s_plant += '<div class="variete"> </div>' 
    s_plant += '<div class="largeur_cm"> </div> <div class="hauteur_cm"> </div>' 
    s_plant += ' <div class="coord_x_cm"> </div> <div class="coord_y_cm"> </div>' 
    s_plant += '<br/><a href="javascript:editePlan(' + "'" + s_nouveauPlanId + "'" + ')"><img src="{{ STATIC_URL }}images/editor.png" width="24" height="24" title="Editer"></a></span> '
    s_plant += '<a href="javascript:supprimePlan('+ "'" + s_nouveauPlanId + "'" + ')"><img src="{{ STATIC_URL }}images/delete.png" width="24" height="24" title="Supprimer"></a></span >'
    s_plant += '</div>'
    
    document.getElementById("matrice").innerHTML += s_plant
    }
   
function supprimePlan(id)
    {
    plant_courant = ''   // plus de plant courant qu'on est en train de detruire
    document.getElementById('matrice').removeChild(document.getElementById(id))
    document.getElementById('divEditPlan').style.display = "none"
    }

function editePlan(id)
    {
	document.getElementById("divEditPlan").style.display = "inline"
	document.getElementById("editPlant_id_planche").innerHTML = {{planche.num}}
    document.getElementById("editPlan_plantId").innerHTML = id
    }

function sauvePlan()
    {
    // recup données et ajout à partir de l'id de plant de la fenetre d'edition
    id_plant = document.getElementById("editPlan_plantId").innerHTML
    id_variet = document.getElementById("editPlan_select_var").value
   
    coord_x_cm = document.getElementById("editPlan_select_var").value
    coord_y_cm = document.getElementById("editPlan_select_var").value
    hauteur_cm = document.getElementById("editPlan_select_var").value
    largeur_cm = document.getElementById("editPlan_select_var").value
    // on affecte les resultats de l'édition dans les attributs du div du plant + mise à jour affiche du plant
    list = document.getElementsByClassName("Plan")
    for(ii=0;ii<list.length;ii++)
        if (list[ii].getAttribute("id") == id_plant)
            {
            list[ii].setAttribute("variete", id_variet)
            // mise à jour affichage
            list[ii].getElementsByClassName("variete")[0].innerHTML = jsonVarietes[id_variet]
            
            // recup taille et mise à jour affichage
            hauteur_cm = parseInt(list[ii].style.height.split('px')[0] / pxParCm)
            list[ii].setAttribute("hauteur_cm", hauteur_cm )
            list[ii].getElementsByClassName("hauteur_cm")[0].innerHTML = "H:" + hauteur_cm + "cm"
            
            largeur_cm = parseInt(list[ii].style.width.split('px')[0] / pxParCm)
            list[ii].setAttribute("largeur_cm", largeur_cm)
            list[ii].getElementsByClassName("largeur_cm ")[0].innerHTML = "L:" + largeur_cm + "cm"

            // recup position et mise à jour affichage
            rect = list[ii].getBoundingClientRect()
            x = parseInt(rect.left  / pxParCm)
            list[ii].setAttribute("coord_x_cm", x)
            list[ii].getElementsByClassName("coord_x_cm")[0].innerHTML = "x:" + x
            y = parseInt(rect.left  / pxParCm)
            list[ii].setAttribute("coord_y_cm", y)
            list[ii].getElementsByClassName("coord_y_cm")[0].innerHTML = "y:" + y

            }
    }
               
     
function ajouteEvenement()
    {
	document.getElementById("divEditEvenement").style.display = "block"
    }

function sauveEvenement()
    {
	// recup données et ajout
	date = document.getElementById("evt_date").value
	nom = document.getElementById("evt_nom").value
	pos_plant = document.getElementById("pos_plant").value
	alert('sauve ' + nom  + " " + date + " du plant " + pos_plant)
	s_request = "cde=ajoutEvt&nom="+ nom + "&date=" + date
    rep = requestServer(s_request)
    }

function sauveMatrice()
    {
    // recup données et envoi plant par plant
    id_planche = {{planche.num}}
    list = document.getElementsByClassName("Plan")
    for(pl=0; pl<list.length; pl++)
        {
        nb_graines = 3
        variete = list[pl].getAttribute("variete")
        largeur_cm = list[pl].getAttribute("largeur_cm")
        hauteur_cm = list[pl].getAttribute("hauteur_cm")
        coord_x_cm = list[pl].getAttribute("coord_x_cm")
        coord_y_cm = list[pl].getAttribute("coord_y_cm")
        
        s_request = "cde=sauve_matrice&id_planche=" + id_planche + "&variete=" + variete + "&largeur_cm="+ largeur_cm +"&hauteur_cm="+ hauteur_cm + "&coord_x_cm="+ coord_x_cm +"&coord_y_cm="+ coord_y_cm
        rep = requestServer(s_request)
        alert('enegistrement' + list[pl].getAttribute("id") + " réponse = " +  rep)
        }
    }
    



function majXYMouse(event) 
    {
    //screenX = event.screenX
    //screenY = event.screenY
    clientX = event.clientX
    clientY = event.clientY

    coordinates =  clientX + ", " + clientY 
   
    if (plant_courant != "")
        {
        obj= document.getElementById(plant_courant)
        rect = obj.getBoundingClientRect()        
        coordinates += ";diff = " + (clientY - rect.top)
        coordinates += "\nplant_courant= " + plant_courant + " style.top " + rect.top + " margins : " + obj.style.marginLeft + "; " + obj.style.marginTop
        }
    //matr = document.getElementById("matrice")
    //coordinates += " || matrice margins" + matr.style.marginLeft + " " + matr.style.marginTop
    
    document.getElementById("divInfoDebug").innerHTML = coordinates

    }

function toggleMove()
    {
    if (plant_courant == "")
        return
        
    obj=document.getElementById(plant_courant)
    rect = obj.getBoundingClientRect()
    if(bEnMouvement == false)
        {
        if ((clientY - rect.top < 40)&&(clientX - rect.left <40 ))  // pour prendre au coin
            {
            bEnMouvement = true
            obj.style.borderColor='yellow'
            }
        }
    else
        {
        bEnMouvement = false
        obj.style.borderColor = 'green'
        }
    }



function deplace()
    {
    if (plant_courant == "")
        return
    
    obj=document.getElementById(plant_courant)
    matr = document.getElementById("matrice")

    if (bEnMouvement)
        {
        obj.style.marginLeft = clientX - matr.offsetLeft - 10 + "px"
        obj.style.marginTop = clientY - matr.offsetTop - 10 + "px"
        } 
    }

</script>

{% endblock %}

{% block title %}Definition de la matrice de la planche {{planche.num}} ({{planche.largeur_cm}}cm x {{planche.longueur_m}}m) {% endblock %}

{% block content %}
{% csrf_token %}

<div id="main" onmousemove="majXYMouse(event);deplace();" style="width: 80%">
<input type="button" onclick="ajoutPlan()" value="Ajout d'un plant">
&nbsp;
<input type="button" onclick="sauveMatrice()" value="Sauvegarde de la matrice de planche">

<span id="divInfoDebug" ></span>
<br/><br/>


<div id="matrice"></div>

<div id="divEditPlan" style="display: none" class="BlueFrame">
	<h2>Gestion du plant implanté en <span id="editPlan_plantId"></span></h2>
	<p>Sur la planche N° <span id="editPlan_id_planche"></span></p>
    Variété : 
    <select id="editPlan_select_var" name="Variete">
    	    {% for var in l_vars %}
    	    <option value="{{var.id}}" name="{{var.nom}}">{{var.nom}}</option>
    	    {% endfor %}
	</select>
	
    <br />Date de début d'activité
    <br/>Evenements<br/>
    <input type='button' value='Sauver le plan' name='sauver' onclick="sauvePlan()"/><br/>                   
    <input type='button' value='Ajouter un évènement' name='ajout' onclick="ajouteEvenement()"/><br/>
</div>

<div class="YellowFrame" style="display: none" id="divEditEvenement">
	<p>
		<h2>Gestion d'évenement</h2>
		Nom : <input type='text' value='' id='evt_nom'/><br/>
		Date (jj-mm-aaaa): <input type='text' value='' id='evt_date'/><br/>
		<input type='button' value='Cancel' name='sauver' onclick="document.getElementById('divEditEvenement').style.display = 'none'" />
		<input type='button' value='OK' name='sauver' onclick="sauveEvenement()" /><br/>

	</p>
</div>



</div>
{% endblock %}
